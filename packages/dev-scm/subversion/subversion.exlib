# Copyright 2008 Bryan Ã˜stergaard <kloeri@exherbo.org>
# Copyright 2008, 2009, 2010 Ingmar Vanhassel <ingmar@exherbo.org>
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'subversion-1.4.6-r2.ebuild' from Gentoo, which is:
#     Copyright 1999-2008 Gentoo Foundation.

require bash-completion autotools [ supported_autoconf=[ 2.5 ] supported_automake=[ none ] ] perl-module python berkdb

export_exlib_phases src_prepare src_configure src_compile src_test_expensive src_install

SUMMARY="A free/open source, centralised version control system"
HOMEPAGE="http://subversion.apache.org/"
DOWNLOADS="http://${PN}.tigris.org/downloads/${PNV}.tar.bz2"

REMOTE_IDS="freshmeat:${PN}"
UPSTREAM_CHANGELOG="http://svn.collab.net/repos/svn/tags/${PV}/CHANGES"
UPSTREAM_RELEASE_NOTES="http://${PN}.tigris.org/svn_$(ever range 1-2)_releasenotes.html"
UPSTREAM_DOCUMENTATION="http://svnbook.red-bean.com/"

LICENCES="Apache-1.1"
SLOT="0"
MYOPTIONS="berkdb perl python ruby
    kde [[ description = [ Adds support to store passwords in kwallet ] ]]
"
RESTRICT="test" # Expensive tests

DEPENDENCIES="
    build:
        sys-devel/gettext
        kde? ( dev-util/pkg-config )
        perl? ( dev-lang/swig[perl] )
        python? ( dev-lang/swig[python] )
        ruby? ( dev-lang/swig[ruby] )
    test-expensive:
        dev-lang/python:*[>=2.2]
    build+run:
        dev-db/sqlite[>=3.4.0]
        dev-libs/apr-util[>=0.9.7][berkdb?]
        net-misc/neon[>=0.25&<0.30]
        berkdb? ( sys-libs/db:=[>=4.0.14&<4.9] )
        kde? (
            kde/kdelibs:4
            sys-apps/dbus[>=1.0]
            x11-libs/qt:4[dbus][X]
        )
        perl? ( dev-lang/perl:= )
        python? ( dev-lang/python:= )
        ruby? ( dev-lang/ruby:= )
    run:
        perl? ( dev-perl/URI )
        kde? ( kde/kdebase-runtime:4 )
    suggestion:
        net-misc/neon[ssl(+)] [[ description = [ Enables support for https:// URIs ] ]]
        net-misc/openssh [[ description = [ Enables support for svn+ssh:// URIs ] ]]"

DEFAULT_SRC_PREPARE_PATCHES=(
    "${FILES}/${PN}-perl-vendor.patch"
    "${FILES}/${PN}-perl-ccopts.patch"
)

subversion_src_prepare() {
    default
    eautoconf # Doesn't use automake
}

subversion_src_configure() {
    myconf=(
        # Needs pkg-config, dbus, glib-2.0 gnome-keyring-1, --enable-shared & apr support for DSOs
        --without-gnome-keyring
    )

    if option perl || option python || option ruby; then
        myconf+=( --with-swig )
    else
        myconf+=( --without-swig )
    fi

    econf \
        --disable-mod-activation \
        --without-sasl \
        --enable-nls \
        --enable-shared \
        ${myconf} \
        $(option_with berkdb berkeley-db "db.h:$(berkdb_includedir)::db-$(berkdb_slot)") \
        $(option_with kde kwallet)
}

subversion_src_compile() {
    default
    option perl && emake swig-pl
    option python && emake swig-py
    option ruby && emake swig-rb
}

subversion_src_test_expensive() {
    emake check
}

subversion_src_install() {
    default

    if option perl; then
        emake DESTDIR="${IMAGE}" install-swig-pl
        fixlocalpod

        # We don't need packlists
        edo find "${IMAGE}/usr/$(get_libdir)" -type f -name .packlist -delete
    fi

    if option python; then
        emake DESTDIR="${IMAGE}" DISTUTIL_PARAM="--prefix=${IMAGE}" LD_LIBRARY_PATH="-L${IMAGE}/usr/$(get_libdir)" install-swig-py

        dodir $(python_get_sitedir)
        edo mv "${IMAGE}"/usr/$(get_libdir)/svn-python/{,lib}svn "${IMAGE}"/$(python_get_sitedir)
        edo rm -rf "${IMAGE}"/usr/$(get_libdir)/svn-python
    fi

    if option ruby; then
        emake DESTDIR="${IMAGE}" install-swig-rb
    fi

    dobashcompletion tools/client-side/bash_completion
}

