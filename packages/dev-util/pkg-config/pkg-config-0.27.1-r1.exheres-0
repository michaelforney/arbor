# Copyright 2007 Bryan Ã˜stergaard
# Distributed under the terms of the GNU General Public License v2

require alternatives

SUMMARY="Helper tool for compiling applications and libraries"
HOMEPAGE="http://www.freedesktop.org/wiki/Software/${PN}"
DOWNLOADS="http://pkgconfig.freedesktop.org/releases/${PNV}.tar.gz"

LICENCES="GPL-2"
SLOT="0"
PLATFORMS="~amd64 ~arm ~ia64 ~ppc64 ~x86"
MYOPTIONS="
    targets:
        arm-exherbo-linux-gnueabi
        i686-pc-linux-gnu
        x86_64-pc-linux-gnu
"

DEPENDENCIES="
    build+run:
        dev-libs/glib:2[>=2.16][hosts:*(-)?]
"

DEFAULT_SRC_CONFIGURE_PARAMS=( '--disable-static' '--without-internal-glib' )

src_configure() {
    local target=

    for target in ${CROSS_COMPILE_TARGETS} ; do
        local pc_path=/usr/${target}/lib/pkgconfig:/usr/share/pkgconfig
        local PKG_CONFIG=$(type -P pkg-config)

        if option !targets:${target} ; then
            echo "    Cross-Compile Target: ${target} (disabled)"
            continue
        fi

        echo "    Cross-Compile Target: ${target}"

        edo mkdir -p "${WORKBASE}/build/${target}"
        edo cd "${WORKBASE}/build/${target}"

            PKG_CONFIG=${PKG_CONFIG:-${CHOST}-pkg-config}       \
        edo "${WORKBASE}/${PNV}/configure"                      \
            --build=${CHOST}                                    \
            --host=${CHOST}                                     \
            --prefix=/usr/${CHOST}                              \
            --datarootdir=/usr/share                            \
            --localstatedir=/var                                \
            --disable-dependency-tracking                       \
            --enable-fast-install                               \
            --with-pc-path=${pc_path}                           \
            --with-system-include-path=/usr/${target}/include   \
            --with-system-library-path=/usr/${target}/lib       \
            --disable-indirect-deps                             \
            --program-prefix=${target}-
    done
}

src_compile() {
    local target=

    for target in ${CROSS_COMPILE_TARGETS} ; do
        if option !targets:${target} ; then
            echo "    Cross-Compile Target: ${target} (disabled)"
            continue
        fi

        echo "    Cross-Compile Target: ${target}"

        edo cd "${WORKBASE}/build/${target}"
        default
    done
}

src_install() {
    local alternatives=(
        pkg-config ${PN} 10

        /usr/share/aclocal/pkg.m4   pkg.m4.${PN}
    )
    local target=

    for target in ${CROSS_COMPILE_TARGETS} ; do
        if option !targets:${target} ; then
            echo "    Cross-Compile Target: ${target} (disabled)"
            continue
        fi

        echo "    Cross-Compile Target: ${target}"

        edo cd "${WORKBASE}/build/${target}"
        emake -j1 DESTDIR="${IMAGE}" install

        alternatives+=( /usr/${CHOST}/bin/${target}-${PN} ${target}-${PN}.pkg-config )
    done

    alternatives_for "${alternatives[@]}"
}

